---
apiVersion: v1
kind: Namespace
metadata:
  name: metallb
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: metallb
spec:
  podSelector: {}
  policyTypes:
    - Ingress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: webhook-allow-ingress
  namespace: metallb
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - ports:
        - protocol: TCP
          port: 9443
---
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: metallb
  namespace: metallb
spec:
  interval: 8h
  timeout: 10m
  url: https://metallb.github.io/metallb
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  annotations:
    kustomize.toolkit.fluxcd.io/force: enabled
  name: metallb
  namespace: metallb
spec:
  chart:
    spec:
      chart: metallb
      reconcileStrategy: ChartVersion
      sourceRef:
        kind: HelmRepository
        name: metallb
      version: '*'
  install:
    crds: Create
    remediation:
      retries: 3
  interval: 24h
  timeout: 10m
  targetNamespace: metallb
  upgrade:
    crds: CreateReplace
    remediation:
      remediateLastFailure: true
  values:
    controller:
      resources:
        requests:
          cpu: 2m
          memory: 57Mi
        limits:
          memory: 57Mi
    speaker:
      resources:
        requests:
          cpu: 3m
          memory: 29Mi
        limits:
          memory: 29Mi
      frr:
        enabled: false
---
apiVersion: notification.toolkit.fluxcd.io/v1beta3
kind: Alert
metadata:
  name: metallb-alert
  namespace: flux-system
spec:
  summary: "MetalLB"
  providerRef:
    name: discord
  eventSeverity: info
  eventSources:
    - kind: HelmRepository
      name: '*'
      namespace: metallb
    - kind: HelmChart
      name: '*'
      namespace: metallb
    - kind: HelmRelease
      name: '*'
      namespace: metallb
# ---
# apiVersion: metallb.io/v1beta1
# kind: IPAddressPool
# metadata:
#   name: default
#   namespace: metallb
# spec:
#   addresses:
#     - 192.168.1.3-192.168.1.10
# ---
# apiVersion: metallb.io/v1beta1
# kind: IPAddressPool
# metadata:
#   name: traefik
#   namespace: metallb
# spec:
#   autoAssign: false
#   addresses:
#     - 192.168.1.2/32
# ---
# apiVersion: metallb.io/v1beta1
# kind: L2Advertisement
# metadata:
#   name: default
#   namespace: metallb
# spec:
#   ipAddressPools:
#     - default
#     - traefik
